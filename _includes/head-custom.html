<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({startOnLoad:true,theme:'neutral'})
    await mermaid.run({querySelector:'code.language-mermaid'})   
</script>

<!-- Load Pako for Zlib compression -->
<script src="cdn.jsdelivr.net"></script>

<script type="module">
  async function renderDiagrams() {
    // Select both structurizr and plantuml blocks
    const selectors = 'code.language-structurizr, code.language-plantuml';
    const codeBlocks = document.querySelectorAll(selectors);

    for (const block of codeBlocks) {
      try {
        const dsl = block.textContent.trim();
        
        // Identify the diagram type (structurizr or plantuml)
        const type = block.classList.contains('language-structurizr') ? 'structurizr' : 'plantuml';
        
        // 1. Encode to UTF-8
        const data = new TextEncoder().encode(dsl);
        // 2. Compress using Zlib (Deflate)
        const compressed = pako.deflate(data, { level: 9 });
        // 3. Convert to URL-safe Base64
        const base64 = btoa(String.fromCharCode(...compressed))
          .replace(/\+/g, '-')
          .replace(/\//g, '_');

        const img = document.createElement('img');
        img.src = `kroki.io/${type}/svg/${base64}`;
        img.style.maxWidth = "100%";
        
        const container = block.parentElement.tagName === 'PRE' ? block.parentElement : block;
        container.parentNode.replaceChild(img, container);
      } catch (err) {
        console.error(`Failed to render ${type} diagram:`, err);
      }
    }
  }

  window.addEventListener('DOMContentLoaded', renderDiagrams);
</script>


<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({startOnLoad:true,theme:'neutral'})
    await mermaid.run({querySelector:'code.language-mermaid'})   
</script>

<!-- 1. Load Pako directly - Ensure this is ABOVE the script below -->
<script src="cdnjs.cloudflare.com"></script>

<script>
// Use a standard function (not an IIFE) to ensure it's easy to debug
function runKroki() {
    console.log("Kroki: Checking for diagrams...");
    
    // Target common Jekyll/Kramdown code block classes
    const selector = 'code.language-structurizr, code.language-plantuml, .language-structurizr code, .language-plantuml code';
    const blocks = document.querySelectorAll(selector);
    
    if (blocks.length === 0) {
        console.log("Kroki: No structurizr or plantuml blocks found on this page.");
        return;
    }

    blocks.forEach(function(block) {
        try {
            const dsl = block.textContent.trim();
            const type = block.classList.contains('language-structurizr') || 
                         block.parentElement.classList.contains('language-structurizr') ? 'structurizr' : 'plantuml';

            // Encoding: UTF8 -> Deflate -> Base64 (URL safe)
            const data = new TextEncoder().encode(dsl);
            const compressed = pako.deflate(data, { level: 9 });
            let binary = '';
            new Uint8Array(compressed).forEach(function(b) { binary += String.fromCharCode(b); });
            const base64 = btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

            const img = document.createElement('img');
            img.src = "kroki.io" + type + "/svg/" + base64;
            img.style.maxWidth = "100%";
            img.style.display = "block";

            // Find the container (usually <pre> or a <div>) and replace it
            const container = block.closest('pre') || block;
            container.parentNode.replaceChild(img, container);
            console.log("Kroki: Rendered a " + type + " diagram.");
        } catch (e) {
            console.error("Kroki Error:", e);
        }
    });
}

// Ensure execution even if script is in <head>
if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', runKroki);
} else {
    runKroki();
}
</script>


